# ============================================================================
# Auto-Approve Package.json Dependency Updates
# ============================================================================
# This workflow automatically approves and enables auto-merge for PRs that only
# modify package.json and lock files (dependency updates).
# ============================================================================

name: Auto-Approve Package Updates

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-package-only:
    name: Check if PR only modifies package files
    runs-on: ubuntu-latest
    outputs:
      package_only: ${{ steps.check-files.outputs.package_only }}
    steps:
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files_yaml: |
            package:
              - 'package.json'
              - 'package-lock.json'
              - 'yarn.lock'
              - 'pnpm-lock.yaml'
            other:
              - '**'
              - '!package.json'
              - '!package-lock.json'
              - '!yarn.lock'
              - '!pnpm-lock.yaml'

      - name: Check if only package files changed
        id: check-files
        run: |
          if [[ "${{ steps.changed-files.outputs.package_any_changed }}" == "true" ]] && \
             [[ "${{ steps.changed-files.outputs.other_any_changed }}" != "true" ]]; then
            echo "package_only=true" >> $GITHUB_OUTPUT
            echo "✓ PR only modifies package.json/lock files"
          else
            echo "package_only=false" >> $GITHUB_OUTPUT
            echo "✗ PR modifies non-package files, skipping auto-approve"
          fi

  auto-approve:
    name: Auto-Approve PR
    needs: check-package-only
    if: needs.check-package-only.outputs.package_only == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Approve PR
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: |
            ✅ Auto-approved: This PR only modifies package.json and/or lock files.

      - name: Enable auto-merge
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

